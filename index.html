<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMAN 1 DRAMAGA - Absensi Online</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a; /* green-600 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 min-h-screen flex flex-col">

    <!-- --- NAVBAR --- -->
    <nav id="navbar" class="bg-green-700 text-white shadow-lg sticky top-0 z-50 hidden">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i data-lucide="school" class="w-8 h-8 text-green-200"></i>
                <div>
                    <h1 class="text-lg font-bold leading-tight">SMAN 1 DRAMAGA</h1>
                    <p class="text-xs text-green-200 opacity-80">Sistem Informasi Presensi (Online)</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-6">
                <div class="text-right hidden md:block">
                    <p id="nav-user-name" class="text-sm font-semibold">User</p>
                    <p id="nav-user-role" class="text-xs text-green-200 capitalize">Role</p>
                </div>
                <button onclick="handleLogout()" class="bg-green-800 hover:bg-green-900 p-2 rounded-full transition" title="Logout">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- --- MAIN CONTENT AREA --- -->
    <main class="flex-grow max-w-6xl mx-auto px-4 py-8 w-full">

        <!-- 1. LOGIN PAGE -->
        <div id="view-login" class="flex items-center justify-center min-h-[80vh]">
            <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md border-t-4 border-green-600">
                <div class="text-center mb-8">
                    <div class="bg-green-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="school" class="w-8 h-8 text-green-600"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-gray-800">SMAN 1 DRAMAGA</h1>
                    <p class="text-gray-500 text-sm">Sistem Absensi Online</p>
                </div>

                <div id="login-error" class="hidden bg-red-100 text-red-600 p-3 rounded-lg mb-4 text-sm flex items-center">
                    <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i> <span id="login-error-msg">Error</span>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <div class="relative">
                            <i data-lucide="user" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
                            <input type="text" id="login-username" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="Masukkan username" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <i data-lucide="lock" class="absolute left-3 top-3 text-gray-400 w-5 h-5"></i>
                            <input type="password" id="login-password" class="w-full pl-10 pr-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none" placeholder="Masukkan password" required>
                        </div>
                    </div>
                    <button type="submit" id="btn-login" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 flex justify-center items-center">
                        Masuk
                    </button>
                </form>
                <div class="mt-6 text-xs text-gray-400 text-center">
                    <p>Isi Konfigurasi Supabase di Script paling bawah file ini.</p>
                </div>
            </div>
        </div>

        <!-- 2. DASHBOARD SISWA -->
        <div id="view-siswa" class="hidden space-y-6">
            <!-- Form Absen -->
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <h2 id="siswa-welcome" class="text-xl font-bold text-gray-800 mb-4">Halo ðŸ‘‹</h2>
                
                <div id="siswa-already-checkin" class="hidden bg-green-50 border border-green-200 p-4 rounded-lg text-center">
                    <i data-lucide="check-circle" class="w-12 h-12 text-green-600 mx-auto mb-2"></i>
                    <h3 class="font-bold text-green-800">Sudah Check-in Hari Ini</h3>
                    <p id="siswa-checkin-detail" class="text-green-700 text-sm"></p>
                </div>

                <div id="siswa-form-area" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Status</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="setAbsenceStatus('Hadir')" id="btn-status-hadir" class="status-btn py-2 rounded-lg border text-sm font-medium transition bg-blue-600 text-white border-blue-600">Hadir</button>
                            <button onclick="setAbsenceStatus('Izin')" id="btn-status-izin" class="status-btn py-2 rounded-lg border text-sm font-medium transition bg-white text-gray-600 hover:bg-gray-50">Izin</button>
                            <button onclick="setAbsenceStatus('Sakit')" id="btn-status-sakit" class="status-btn py-2 rounded-lg border text-sm font-medium transition bg-white text-gray-600 hover:bg-gray-50">Sakit</button>
                        </div>
                    </div>

                    <textarea id="siswa-reason" class="hidden w-full p-3 border rounded-lg text-sm" placeholder="Tulis alasan..."></textarea>

                    <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                        <div class="flex items-center text-sm text-gray-600 overflow-hidden">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-2 flex-shrink-0"></i>
                            <span id="siswa-location-text" class="truncate">Lokasi belum diambil</span>
                        </div>
                        <button onclick="getLocation()" id="btn-get-loc" class="text-xs text-blue-600 font-semibold hover:underline whitespace-nowrap ml-2">
                            Ambil Lokasi
                        </button>
                    </div>

                    <button onclick="handleCheckIn()" id="btn-checkin-submit" class="w-full py-3 rounded-lg font-bold text-white bg-gray-400 cursor-not-allowed" disabled>
                        Kirim Absensi
                    </button>
                </div>
            </div>

            <!-- Riwayat -->
            <div class="bg-white p-6 rounded-xl shadow-sm border">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center"><i data-lucide="calendar" class="w-4 h-4 mr-2"></i> Riwayat</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr><th class="p-3">Tgl</th><th class="p-3">Status</th><th class="p-3">Waktu</th><th class="p-3">Ket</th></tr>
                        </thead>
                        <tbody id="siswa-history-body">
                            <!-- Data loaded via JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 3. DASHBOARD WALI KELAS -->
        <div id="view-wali" class="hidden space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border flex flex-col md:flex-row justify-between gap-4">
                <div>
                    <h2 id="wali-class-title" class="text-xl font-bold text-gray-800">Kelas: -</h2>
                    <p class="text-gray-500 text-sm">Rekapitulasi Database Online</p>
                </div>
                <div class="flex flex-wrap gap-2 items-center">
                    <!-- Filter Mode -->
                    <select id="wali-filter-mode" onchange="handleWaliFilterChange()" class="border rounded-lg px-3 py-2 text-sm bg-gray-50">
                        <option value="harian">Harian</option>
                        <option value="mingguan">Mingguan</option>
                        <option value="bulanan">Bulanan</option>
                    </select>
                    
                    <!-- Dynamic Date Input -->
                    <div id="wali-date-container">
                        <input type="date" id="wali-date-input" onchange="fetchWaliData()" class="border rounded-lg px-3 py-2 text-sm">
                    </div>

                    <!-- View Mode Toggle -->
                     <div class="flex bg-gray-100 rounded-lg p-1">
                        <button onclick="setWaliViewMode('rekap')" id="btn-view-rekap" class="px-3 py-1 text-sm rounded-md flex items-center bg-white shadow text-green-700 font-medium">
                            <i data-lucide="bar-chart" class="w-3 h-3 mr-1"></i> Rekap
                        </button>
                        <button onclick="setWaliViewMode('detail')" id="btn-view-detail" class="px-3 py-1 text-sm rounded-md flex items-center text-gray-500">
                            <i data-lucide="file-text" class="w-3 h-3 mr-1"></i> Detail
                        </button>
                     </div>

                    <button onclick="exportWaliCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center">
                        <i data-lucide="download" class="w-4 h-4 mr-2"></i> Export
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border overflow-hidden overflow-x-auto">
                 <div id="wali-loading" class="p-8 text-center hidden"><div class="loader"></div><span class="ml-2">Memuat...</span></div>
                 
                 <!-- Tabel Detail -->
                 <table id="table-wali-detail" class="w-full text-sm text-left hidden">
                    <thead class="bg-gray-100 text-gray-700 font-semibold">
                        <tr><th class="p-4">Nama</th><th class="p-4">Tanggal</th><th class="p-4">Status</th><th class="p-4">Waktu</th><th class="p-4">Lokasi/Ket</th></tr>
                    </thead>
                    <tbody id="wali-tbody-detail"></tbody>
                 </table>

                 <!-- Tabel Rekap -->
                 <table id="table-wali-rekap" class="w-full text-sm text-left">
                    <thead class="bg-green-50 text-green-800 font-semibold">
                        <tr>
                            <th class="p-4">Nama Siswa</th>
                            <th class="p-4 text-center">Hadir</th>
                            <th class="p-4 text-center">Izin</th>
                            <th class="p-4 text-center">Sakit</th>
                            <th class="p-4 text-center">Total</th>
                        </tr>
                    </thead>
                    <tbody id="wali-tbody-rekap"></tbody>
                 </table>
            </div>
        </div>

        <!-- 4. DASHBOARD ADMIN -->
        <div id="view-admin" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">Manajemen User (Database)</h2>
                <button onclick="seedDummyData()" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded flex items-center">
                   <i data-lucide="database" class="w-3 h-3 mr-1"></i> Seed Dummy
                </button>
            </div>

            <div class="grid md:grid-cols-3 gap-6">
                <!-- Form Add -->
                <div class="md:col-span-1 bg-white p-5 rounded-xl shadow-sm border h-fit">
                    <h3 class="font-bold mb-4 text-gray-800">Tambah User</h3>
                    <form onsubmit="handleAddUser(event)" class="space-y-3">
                        <input type="text" id="add-name" required placeholder="Nama Lengkap" class="w-full p-2 border rounded text-sm">
                        <input type="text" id="add-username" required placeholder="Username" class="w-full p-2 border rounded text-sm">
                        <input type="password" id="add-password" required placeholder="Password" class="w-full p-2 border rounded text-sm">
                        
                        <select id="add-role" onchange="toggleAddClassInput()" class="w-full p-2 border rounded text-sm bg-white">
                            <option value="siswa">Siswa</option>
                            <option value="wali">Wali Kelas</option>
                            <option value="admin">Admin</option>
                        </select>

                        <input type="text" id="add-class" placeholder="Nama Kelas (Cth: XII-IPA-1)" class="w-full p-2 border rounded text-sm">
                        
                        <button type="submit" id="btn-add-user" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 text-sm font-bold flex justify-center items-center">
                            <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Simpan
                        </button>
                    </form>
                </div>

                <!-- List Users -->
                <div class="md:col-span-2 bg-white p-5 rounded-xl shadow-sm border">
                   <div class="overflow-auto max-h-[400px]">
                     <table class="w-full text-sm text-left">
                       <thead class="bg-gray-100 sticky top-0">
                         <tr><th class="p-3">Nama</th><th class="p-3">Role</th><th class="p-3">Kelas</th><th class="p-3">Aksi</th></tr>
                       </thead>
                       <tbody id="admin-user-list">
                           <!-- Loaded via JS -->
                       </tbody>
                     </table>
                   </div>
                </div>
            </div>
        </div>

    </main>

    <footer class="text-center text-gray-400 text-sm py-6 mt-auto bg-gray-200">
        &copy; 2025 SMAN 1 DRAMAGA - Single File App
    </footer>

    <!-- --- JAVASCRIPT LOGIC --- -->
    <script>
        // --- 1. KONFIGURASI (ISI DI SINI) ---
        const SUPABASE_URL = 'https://axpqonekuzxhlsoqiaxt.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4cHFvbmVrdXp4aGxzb3FpYXh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MzQ5NjIsImV4cCI6MjA3OTIxMDk2Mn0.QAFHvMM8j3pr3UcASttj8B6CwdmEfQXMCWA8tVBKeak';

        // Global Vars
        let supabase = null;
        let currentUser = null;
        let currentLoc = null;
        let studentStatus = 'Hadir';
        
        // Wali Vars
        let waliFilterMode = 'harian';
        let waliFilterValue = new Date().toISOString().split('T')[0];
        let waliViewMode = 'rekap';
        let waliAbsences = [];
        let waliStudents = [];

        // --- UTILS ---
        const hashPassword = (password) => `hashed_${password.split('').reverse().join('')}`;
        const checkPassword = (input, stored) => hashPassword(input) === stored;

        // Inisialisasi Ikon Lucide
        lucide.createIcons();

        // --- INITIALIZATION ---
        window.onload = function() {
            if(SUPABASE_URL && SUPABASE_KEY) {
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    console.log("Supabase initialized");
                } catch(e) {
                    alert("Gagal init Supabase. Cek console.");
                    console.error(e);
                }
            } else {
                alert("MOHON ISI SUPABASE_URL DAN KEY DI DALAM KODE HTML (Bagian Script bawah)");
            }

            // Check Session
            const stored = localStorage.getItem('sman1_session');
            if(stored) {
                currentUser = JSON.parse(stored);
                renderDashboard();
            } else {
                showView('login');
            }
        };

        function showView(viewName) {
            // Hide all
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-siswa').classList.add('hidden');
            document.getElementById('view-wali').classList.add('hidden');
            document.getElementById('view-admin').classList.add('hidden');
            document.getElementById('navbar').classList.add('hidden');

            // Show target
            document.getElementById(`view-${viewName}`).classList.remove('hidden');

            if(viewName !== 'login') {
                document.getElementById('navbar').classList.remove('hidden');
                document.getElementById('nav-user-name').innerText = currentUser.name;
                document.getElementById('nav-user-role').innerText = currentUser.role === 'wali' ? 'Wali Kelas' : currentUser.role;
            }
            lucide.createIcons();
        }

        function renderDashboard() {
            if(!currentUser) return;
            if(currentUser.role === 'siswa') {
                showView('siswa');
                initDashboardSiswa();
            } else if (currentUser.role === 'wali') {
                showView('wali');
                initDashboardWali();
            } else if (currentUser.role === 'admin') {
                showView('admin');
                initDashboardAdmin();
            }
        }

        async function handleLogout() {
            localStorage.removeItem('sman1_session');
            currentUser = null;
            showView('login');
        }

        // --- AUTH LOGIC ---
        async function handleLogin(e) {
            e.preventDefault();
            if(!supabase) return alert("Supabase belum dikonfigurasi");

            const u = document.getElementById('login-username').value;
            const p = document.getElementById('login-password').value;
            const btn = document.getElementById('btn-login');
            const errMsg = document.getElementById('login-error');
            
            btn.innerText = "Memuat...";
            btn.disabled = true;
            errMsg.classList.add('hidden');

            try {
                const { data: user, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', u)
                    .single();
                
                if(error || !user) throw new Error("Username tidak ditemukan");
                
                if(checkPassword(p, user.password)) {
                    currentUser = user;
                    localStorage.setItem('sman1_session', JSON.stringify(user));
                    renderDashboard();
                    // Clear form
                    document.getElementById('login-username').value = '';
                    document.getElementById('login-password').value = '';
                } else {
                    throw new Error("Password salah");
                }
            } catch(err) {
                document.getElementById('login-error-msg').innerText = err.message;
                errMsg.classList.remove('hidden');
            } finally {
                btn.innerText = "Masuk";
                btn.disabled = false;
            }
        }

        // --- SISWA LOGIC ---
        function initDashboardSiswa() {
            document.getElementById('siswa-welcome').innerText = `Halo, ${currentUser.name} ðŸ‘‹`;
            resetSiswaForm();
            fetchSiswaHistory();
        }

        function setAbsenceStatus(status) {
            studentStatus = status;
            // Reset buttons styling
            ['hadir','izin','sakit'].forEach(type => {
                const btn = document.getElementById(`btn-status-${type}`);
                if(type === status.toLowerCase()) {
                    btn.className = "status-btn py-2 rounded-lg border text-sm font-medium transition bg-blue-600 text-white border-blue-600";
                } else {
                    btn.className = "status-btn py-2 rounded-lg border text-sm font-medium transition bg-white text-gray-600 hover:bg-gray-50";
                }
            });
            
            // Show reason textarea if not Hadir
            const reasonArea = document.getElementById('siswa-reason');
            if(status !== 'Hadir') reasonArea.classList.remove('hidden');
            else reasonArea.classList.add('hidden');

            validateCheckInButton();
        }

        function getLocation() {
            const btn = document.getElementById('btn-get-loc');
            const txt = document.getElementById('siswa-location-text');
            btn.innerText = "Mencari...";
            
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    currentLoc = `${pos.coords.latitude}, ${pos.coords.longitude}`;
                    txt.innerText = currentLoc;
                    btn.innerText = "Ambil Ulang";
                    validateCheckInButton();
                }, () => {
                    txt.innerText = "Gagal ambil lokasi (Izin?)";
                    btn.innerText = "Coba Lagi";
                    currentLoc = null;
                });
            } else {
                txt.innerText = "Browser tidak support GPS";
                btn.innerText = "-";
            }
        }

        function validateCheckInButton() {
            const btn = document.getElementById('btn-checkin-submit');
            // Hadir but no location -> disabled
            if(studentStatus === 'Hadir' && !currentLoc) {
                btn.disabled = true;
                btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
            } else {
                btn.disabled = false;
                btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        }

        async function handleCheckIn() {
            const reasonVal = document.getElementById('siswa-reason').value;
            const btn = document.getElementById('btn-checkin-submit');
            btn.innerText = "Mengirim...";
            btn.disabled = true;

            const newRecord = {
                user_id: currentUser.id,
                user_name: currentUser.name,
                user_class: currentUser.class_id,
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('id-ID'),
                timestamp: new Date().toISOString(),
                status: studentStatus,
                reason: studentStatus === 'Hadir' ? '-' : reasonVal,
                location: currentLoc || 'Tanpa Lokasi'
            };

            try {
                const { error } = await supabase.from('attendance').insert([newRecord]);
                if(error) throw error;
                alert("Absensi berhasil!");
                resetSiswaForm();
                fetchSiswaHistory();
            } catch(e) {
                alert("Gagal: " + e.message);
            } finally {
                btn.innerText = "Kirim Absensi";
                validateCheckInButton(); // restore state
            }
        }

        async function fetchSiswaHistory() {
            const tbody = document.getElementById('siswa-history-body');
            const todayDiv = document.getElementById('siswa-already-checkin');
            const formArea = document.getElementById('siswa-form-area');

            const { data, error } = await supabase
                .from('attendance')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('timestamp', {ascending: false});

            tbody.innerHTML = '';
            let checkedInToday = false;

            if(data) {
                const todayStr = new Date().toISOString().split('T')[0];
                
                data.forEach(row => {
                    if(row.date === todayStr) {
                        checkedInToday = true;
                        document.getElementById('siswa-checkin-detail').innerText = `Status: ${row.status} â€¢ Pukul: ${row.time}`;
                    }
                    const colorClass = row.status === 'Hadir' ? 'bg-green-100 text-green-700' : 
                                       row.status === 'Sakit' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700';
                    
                    const tr = `
                        <tr class="border-b">
                            <td class="p-3">${row.date}</td>
                            <td class="p-3"><span class="px-2 py-1 rounded-full text-xs font-bold ${colorClass}">${row.status}</span></td>
                            <td class="p-3">${row.time}</td>
                            <td class="p-3 text-gray-500 truncate max-w-[100px]">${row.reason}</td>
                        </tr>
                    `;
                    tbody.innerHTML += tr;
                });
            }

            if(checkedInToday) {
                todayDiv.classList.remove('hidden');
                formArea.classList.add('hidden');
            } else {
                todayDiv.classList.add('hidden');
                formArea.classList.remove('hidden');
            }
        }

        function resetSiswaForm() {
            setAbsenceStatus('Hadir');
            currentLoc = null;
            document.getElementById('siswa-location-text').innerText = "Lokasi belum diambil";
            document.getElementById('btn-get-loc').innerText = "Ambil Lokasi";
            document.getElementById('siswa-reason').value = '';
            validateCheckInButton();
        }


        // --- WALI KELAS LOGIC ---
        function initDashboardWali() {
            document.getElementById('wali-class-title').innerText = `Kelas: ${currentUser.class_id}`;
            fetchWaliData();
        }

        function handleWaliFilterChange() {
            waliFilterMode = document.getElementById('wali-filter-mode').value;
            const inputContainer = document.getElementById('wali-date-container');
            
            // Re-render input based on type
            if(waliFilterMode === 'bulanan') {
                inputContainer.innerHTML = `<input type="month" id="wali-date-input" onchange="handleDateInput(this.value)" class="border rounded-lg px-3 py-2 text-sm">`;
                const now = new Date().toISOString().slice(0,7);
                document.getElementById('wali-date-input').value = now;
                waliFilterValue = now;
            } else if (waliFilterMode === 'mingguan') {
                inputContainer.innerHTML = `<input type="week" id="wali-date-input" onchange="handleDateInput(this.value)" class="border rounded-lg px-3 py-2 text-sm">`;
                // Simple week logic
                // For simplicity, just defaulting to text input update logic in handleDateInput
            } else {
                inputContainer.innerHTML = `<input type="date" id="wali-date-input" onchange="handleDateInput(this.value)" class="border rounded-lg px-3 py-2 text-sm">`;
                const now = new Date().toISOString().split('T')[0];
                document.getElementById('wali-date-input').value = now;
                waliFilterValue = now;
            }
            fetchWaliData();
        }

        function handleDateInput(val) {
            waliFilterValue = val;
            fetchWaliData();
        }

        function setWaliViewMode(mode) {
            waliViewMode = mode;
            const btnRekap = document.getElementById('btn-view-rekap');
            const btnDetail = document.getElementById('btn-view-detail');
            const tblRekap = document.getElementById('table-wali-rekap');
            const tblDetail = document.getElementById('table-wali-detail');

            if(mode === 'rekap') {
                btnRekap.className = "px-3 py-1 text-sm rounded-md flex items-center bg-white shadow text-green-700 font-medium";
                btnDetail.className = "px-3 py-1 text-sm rounded-md flex items-center text-gray-500";
                tblRekap.classList.remove('hidden');
                tblDetail.classList.add('hidden');
            } else {
                btnRekap.className = "px-3 py-1 text-sm rounded-md flex items-center text-gray-500";
                btnDetail.className = "px-3 py-1 text-sm rounded-md flex items-center bg-white shadow text-green-700 font-medium";
                tblRekap.classList.add('hidden');
                tblDetail.classList.remove('hidden');
            }
        }

        // Helper date range (Same as React version)
        function getDateRange(mode, value) {
            let start, end;
            if(!value) return {start: '', end: ''}; // safety

            if (mode === 'harian') {
                start = value;
                end = value;
            } else if (mode === 'mingguan') {
                const [year, week] = value.split('-W');
                const simpleDate = new Date(year, 0, 1 + (week - 1) * 7);
                const dayOfWeek = simpleDate.getDay();
                const isoWeekStart = simpleDate;
                if (dayOfWeek <= 4)
                    isoWeekStart.setDate(simpleDate.getDate() - simpleDate.getDay() + 1);
                else
                    isoWeekStart.setDate(simpleDate.getDate() + 8 - simpleDate.getDay());
                
                start = isoWeekStart.toISOString().split('T')[0];
                const endObj = new Date(isoWeekStart);
                endObj.setDate(endObj.getDate() + 6);
                end = endObj.toISOString().split('T')[0];
            } else if (mode === 'bulanan') {
                start = `${value}-01`;
                const [y, m] = value.split('-');
                const endObj = new Date(y, m, 0); 
                end = endObj.toISOString().split('T')[0];
            }
            return { start, end };
        }

        async function fetchWaliData() {
            document.getElementById('wali-loading').classList.remove('hidden');
            document.getElementById('table-wali-rekap').classList.add('hidden');
            document.getElementById('table-wali-detail').classList.add('hidden');

            try {
                // 1. Get Students
                if(waliStudents.length === 0) {
                    const { data } = await supabase.from('users').select('*').eq('class_id', currentUser.class_id).eq('role','siswa');
                    if(data) waliStudents = data;
                }

                // 2. Get Absences
                const { start, end } = getDateRange(waliFilterMode, waliFilterValue);
                if(!start) throw new Error("Tanggal invalid");

                const { data: att } = await supabase.from('attendance')
                    .select('*')
                    .eq('user_class', currentUser.class_id)
                    .gte('date', start)
                    .lte('date', end);
                
                if(att) waliAbsences = att;

                renderWaliTables();

            } catch(e) {
                console.error(e);
            } finally {
                document.getElementById('wali-loading').classList.add('hidden');
                // Restore visible table based on mode
                setWaliViewMode(waliViewMode);
            }
        }

        function renderWaliTables() {
            // Render Detail
            const tbodyDetail = document.getElementById('wali-tbody-detail');
            tbodyDetail.innerHTML = '';
            if(waliAbsences.length === 0) {
                tbodyDetail.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Tidak ada data.</td></tr>`;
            } else {
                waliAbsences.forEach(row => {
                    const colorClass = row.status === 'Hadir' ? 'bg-green-100 text-green-700' : 
                                       row.status === 'Sakit' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700';
                    const loc = row.status === 'Hadir' ? row.location : row.reason;
                    const tr = `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4 font-medium">${row.user_name}</td>
                            <td class="p-4 text-gray-500">${row.date}</td>
                            <td class="p-4"><span class="px-2 py-1 rounded-full text-xs font-bold ${colorClass}">${row.status}</span></td>
                            <td class="p-4">${row.time}</td>
                            <td class="p-4 text-gray-500 text-xs">${loc}</td>
                        </tr>`;
                    tbodyDetail.innerHTML += tr;
                });
            }

            // Render Rekap
            const tbodyRekap = document.getElementById('wali-tbody-rekap');
            tbodyRekap.innerHTML = '';
            if(waliStudents.length === 0) {
                tbodyRekap.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-400">Belum ada siswa terdaftar.</td></tr>`;
            } else {
                waliStudents.forEach(stu => {
                    const stuAtt = waliAbsences.filter(a => a.user_id === stu.id);
                    const hadir = stuAtt.filter(a => a.status === 'Hadir').length;
                    const izin = stuAtt.filter(a => a.status === 'Izin').length;
                    const sakit = stuAtt.filter(a => a.status === 'Sakit').length;
                    const total = hadir + izin + sakit;

                    const tr = `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="p-4 font-medium">${stu.name}</td>
                            <td class="p-4 text-center text-green-600 font-bold">${hadir}</td>
                            <td class="p-4 text-center text-blue-600">${izin}</td>
                            <td class="p-4 text-center text-yellow-600">${sakit}</td>
                            <td class="p-4 text-center text-gray-600">${total}</td>
                        </tr>`;
                    tbodyRekap.innerHTML += tr;
                });
            }
        }
        
        function exportWaliCSV() {
            let csv = "data:text/csv;charset=utf-8,";
            if(waliViewMode === 'detail') {
                csv += "Nama,Tanggal,Status,Waktu,Keterangan\n";
                waliAbsences.forEach(r => {
                    csv += `${r.user_name},${r.date},${r.status},${r.time},${r.reason}\n`;
                });
            } else {
                csv += "Nama,Hadir,Izin,Sakit\n";
                waliStudents.forEach(stu => {
                    const stuAtt = waliAbsences.filter(a => a.user_id === stu.id);
                    const h = stuAtt.filter(a => a.status === 'Hadir').length;
                    const i = stuAtt.filter(a => a.status === 'Izin').length;
                    const s = stuAtt.filter(a => a.status === 'Sakit').length;
                    csv += `${stu.name},${h},${i},${s}\n`;
                });
            }
            const link = document.createElement("a");
            link.setAttribute("href", encodeURI(csv));
            link.setAttribute("download", `Laporan_${waliViewMode}_${currentUser.class_id}.csv`);
            document.body.appendChild(link);
            link.click();
        }


        // --- ADMIN LOGIC ---
        function initDashboardAdmin() {
            fetchAdminUsers();
        }

        function toggleAddClassInput() {
            const role = document.getElementById('add-role').value;
            const classInput = document.getElementById('add-class');
            if(role === 'admin') {
                classInput.classList.add('hidden');
                classInput.value = '';
            } else {
                classInput.classList.remove('hidden');
            }
        }

        async function fetchAdminUsers() {
            const tbody = document.getElementById('admin-user-list');
            const { data } = await supabase.from('users').select('*').order('id');
            tbody.innerHTML = '';
            if(data) {
                data.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.className = 'border-b';
                    tr.innerHTML = `
                        <td class="p-3 font-medium">${u.name} <br/><span class="text-xs text-gray-400">@${u.username}</span></td>
                        <td class="p-3 capitalize">${u.role}</td>
                        <td class="p-3">${u.class_id || '-'}</td>
                        <td class="p-3">
                             ${u.username !== 'admin' ? `<button onclick="deleteUser(${u.id})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            }
        }

        async function handleAddUser(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-add-user');
            btn.disabled = true;
            btn.innerText = "...";

            const newUser = {
                name: document.getElementById('add-name').value,
                username: document.getElementById('add-username').value,
                password: hashPassword(document.getElementById('add-password').value),
                role: document.getElementById('add-role').value,
                class_id: document.getElementById('add-role').value === 'admin' ? null : document.getElementById('add-class').value
            };

            const { error } = await supabase.from('users').insert([newUser]);
            if(error) alert("Gagal: " + error.message);
            else {
                alert("User berhasil ditambahkan");
                fetchAdminUsers();
                // reset fields
                document.getElementById('add-name').value = '';
                document.getElementById('add-username').value = '';
                document.getElementById('add-password').value = '';
            }
            btn.disabled = false;
            btn.innerHTML = `<i data-lucide="plus" class="w-4 h-4 mr-1"></i> Simpan`;
            lucide.createIcons();
        }

        async function deleteUser(id) {
            if(confirm("Hapus user ini permanen?")) {
                await supabase.from('users').delete().eq('id', id);
                fetchAdminUsers();
            }
        }

        async function seedDummyData() {
            if(!confirm("Isi data dummy?")) return;
            const dummy = [
                { username: 'guru', password: hashPassword('guru'), role: 'wali', name: 'Budi Santoso', class_id: 'XII-IPA-1' },
                { username: 'siswa', password: hashPassword('siswa'), role: 'siswa', name: 'Ahmad Rizky', class_id: 'XII-IPA-1' },
            ];
            await supabase.from('users').insert(dummy);
            fetchAdminUsers();
            alert("Data dummy masuk!");
        }
    </script>
</body>
</html>
